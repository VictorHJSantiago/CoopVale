{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Catálogo de Produtos</h2>
  <form method="GET" class="row mb-4">
    <div class="col-md-3">
      <input type="text" class="form-control" name="busca" placeholder="Buscar por nome ou tag" value="{{ request.args.get('busca', '') }}">
    </div>
    <div class="col-md-3">
      <select class="form-select" name="categoria_id">
        <option value="">Todas as Categorias</option>
        {% for categoria in categorias %}
        <option value="{{ categoria.id }}" {% if request.args.get('categoria_id') == categoria.id|string %}selected{% endif %}>{{ categoria.nome }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control" name="produtor" placeholder="Produtor" value="{{ request.args.get('produtor', '') }}">
    </div>
    <div class="col-md-3 mb-2">
      <input type="number" step="0.01" class="form-control mb-2" name="preco_min" placeholder="Preço mínimo" value="{{ request.args.get('preco_min', '') }}">
      <input type="number" step="0.01" class="form-control mb-2" name="preco_max" placeholder="Preço máximo" value="{{ request.args.get('preco_max', '') }}">
      <input type="text" class="form-control mb-2" name="tag" placeholder="Tag (ex: orgânico)" value="{{ request.args.get('tag', '') }}">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="so_organico" id="so_organico" value="1" {% if request.args.get('so_organico') %}checked{% endif %}>
        <label class="form-check-label" for="so_organico">Apenas Orgânicos</label>
      </div>
      <button type="submit" class="btn btn-primary w-100 mt-2">Filtrar</button>
    </div>
  </form>
  <div class="row">
    {% for produto in produtos %}
    <div class="col-md-4 mb-4">
      <div class="card h-100">
        {% if produto.imagens %}
        <img src="{{ produto.imagens.split(',')[0] }}" class="card-img-top" alt="Imagem do produto">
        {% endif %}
        <div class="card-body">
          <h5 class="card-title">{{ produto.nome }}</h5>
          <p class="card-text">{{ produto.descricao }}</p>
          <p class="card-text"><strong>Categoria:</strong> {{ produto.categoria.nome if produto.categoria else '' }}</p>
          <p class="card-text"><strong>Preço:</strong> R$ {{ '%.2f'|format(produto.preco) }} / {{ produto.unidade }}</p>
          <p class="card-text"><strong>Produtor:</strong> {{ produto.produtor.nome if produto.produtor else '' }}</p>
          <form action="{{ url_for('pedidos_bp.adicionar_ao_carrinho', produto_id=produto.id) }}" method="post">
            <div class="input-group mb-2">
              <input type="number" name="quantidade" value="1" min="1" max="{{ produto.estoque }}" class="form-control" style="max-width:80px;">
              <div class="input-group-append">
                <button type="submit" class="btn btn-success">Adicionar ao Carrinho</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% if not produtos %}
  <div class="alert alert-info">Nenhum produto encontrado.</div>
  {% endif %}
</div>
{% endblock %}
