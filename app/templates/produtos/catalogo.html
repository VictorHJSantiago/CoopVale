{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Catálogo de Produtos</h2>
  {% if current_user.is_authenticated and current_user.tipo_usuario == 'produtor' %}
  <div class="mb-3">
    <a class="btn btn-success" href="{{ url_for('produtores.meus_produtos_novo') }}">Cadastrar Produto</a>
    <a class="btn btn-outline-secondary ms-2" href="{{ url_for('produtores.meus_produtos') }}">Meus Produtos</a>
  </div>
  {% endif %}
  <form method="GET" class="row mb-4">
    <div class="col-md-3">
      <input type="text" class="form-control" name="busca" placeholder="Buscar por nome ou tag" value="{{ request.args.get('busca', '') }}">
    </div>
    <div class="col-md-3">
      <select class="form-select" name="categoria_id">
        <option value="">Todas as Categorias</option>
        {% for categoria in categorias %}
        <option value="{{ categoria.id }}" {% if request.args.get('categoria_id') == categoria.id|string %}selected{% endif %}>{{ categoria.nome }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control" name="produtor" placeholder="Produtor" value="{{ request.args.get('produtor', '') }}">
    </div>
    <div class="col-md-3 mb-2">
      <input type="number" step="0.01" class="form-control mb-2" name="preco_min" placeholder="Preço mínimo" value="{{ request.args.get('preco_min', '') }}">
      <input type="number" step="0.01" class="form-control mb-2" name="preco_max" placeholder="Preço máximo" value="{{ request.args.get('preco_max', '') }}">
      <input type="text" class="form-control mb-2" name="tag" placeholder="Tag (ex: orgânico)" value="{{ request.args.get('tag', '') }}">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="so_organico" id="so_organico" value="1" {% if request.args.get('so_organico') %}checked{% endif %}>
        <label class="form-check-label" for="so_organico">Apenas Orgânicos</label>
      </div>
      <button type="submit" class="btn btn-primary w-100 mt-2">Filtrar</button>
    </div>
  </form>
  <div class="row">
    {% for p in produtos %}
      <div class="col-md-3 mb-4 fade-in">
        <div class="card h-100 border {% if p.preco_promocional %}border-success{% endif %}">
          {% set img = (p.imagens.split(',')[0] if p.imagens) %}
          <img src="{{ url_for('static', filename=img if img else 'images/placeholders/produto.svg') }}" class="card-img-top" alt="Imagem do produto">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">
              {{ p.nome }}
              {% if p.preco_promocional %}<span class="badge bg-success">Promoção</span>{% endif %}
                {% set hoje = namespace(val=datetime.now(timezone.utc)) %}
                {% if p.sazonal_inicio and p.sazonal_fim and p.sazonal_inicio <= hoje.val <= p.sazonal_fim %}
                <span class="badge bg-warning text-dark">Sazonal</span>
                {% endif %}
            </h5>
            <p class="card-text flex-grow-1">{{ p.descricao[:80] }}...</p>
            <p class="mb-2">
              {% if p.preco_promocional %}
                <span class="text-decoration-line-through text-muted">R$ {{ p.preco|round(2) }}</span>
                <strong class="text-success d-block">R$ {{ p.preco_promocional|round(2) }}</strong>
              {% else %}
                <strong>R$ {{ p.preco|round(2) }}</strong>
              {% endif %}
              <span class="text-muted">/ {{ p.unidade }}</span>
            </p>
            {% if p.origem %}<p class="small text-muted mb-2">Origem: {{ p.origem }}</p>{% endif %}
            <a href="{{ url_for('produtos_bp.detalhe', produto_id=p.id) }}" class="btn btn-sm btn-outline-primary mt-auto">Ver Detalhes</a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% if not produtos %}
  <div class="alert alert-info">Nenhum produto encontrado.</div>
  {% endif %}
</div>
{% endblock %}
